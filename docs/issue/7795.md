# Issue #7795: Dynamic colors don't adjust to color change

## Issue Summary

**Reporter:** @leoheitmannruiz
**App Version:** 3.8.0
**Android Version:** 15
**Device:** Pixel 6a
**Status:** Confirmed bug

### Problem Description
When dynamic colors are enabled in AntennaPod, the app colors do not automatically update when the user changes their system wallpaper (which affects Material You dynamic colors). The user must force stop the app to see the color changes applied.

### Current Behavior
1. User enables "Dynamic colors" in settings
2. User plays an episode
3. User changes system wallpaper color
4. User reopens AntennaPod
5. **Result**: App colors remain unchanged

### Expected Behavior
App colors should automatically update to reflect the new system dynamic colors when the wallpaper changes, without requiring a force stop.

## Technical Analysis

### Current Implementation

#### Dynamic Color Setup (`PodcastApp.java:44`)
```java
DynamicColors.applyToActivitiesIfAvailable(this);
```
- Applied once at application startup
- Uses Material Design 3 dynamic colors API
- No ongoing listener for color changes

#### Theme Detection (`ThemeSwitcher.java:11`)
```java
boolean dynamic = UserPreferences.getIsThemeColorTinted();
```
- Preference-based check for dynamic colors enabled
- Only available on Android 12+ (API 31+)

#### Theme Change Detection (`MainActivity.java:580-583`)
```java
if (lastTheme != ThemeSwitcher.getNoTitleTheme(this)
        || hasBottomNavigation != UserPreferences.isBottomNavigationEnabled()) {
    restartActivity();
}
```
- Detects theme changes in `onResume()` and `onConfigurationChanged()`
- Restarts activity when theme change detected

### Root Cause Analysis

1. **Timing Issue**: Dynamic color changes from wallpaper updates don't always trigger `onConfigurationChanged()`
2. **Detection Gap**: The app only checks for theme changes during activity lifecycle events
3. **No Active Monitoring**: No real-time listener for system color scheme changes
4. **Static Application**: `DynamicColors.applyToActivitiesIfAvailable()` is only called once at startup

## Solution Strategy

### Approach 1: Enhanced Configuration Change Handling (Recommended)

**Concept**: Improve the existing configuration change detection to be more responsive to dynamic color changes.

#### Implementation Plan

1. **Modify AndroidManifest.xml**
   - Add `uiMode` to configuration changes for relevant activities
   - Ensure dynamic color changes trigger `onConfigurationChanged()`

2. **Enhance MainActivity Configuration Handling**
   - Add explicit dynamic color change detection in `onConfigurationChanged()`
   - Check for Material You color scheme changes
   - Trigger activity restart when dynamic colors change

3. **Add Proactive Color Monitoring**
   - Implement a background check for dynamic color changes
   - Use `Application.registerActivityLifecycleCallbacks()` to monitor all activities
   - Apply fresh dynamic colors when changes detected

### Approach 2: Dynamic Color Refresh Service

**Concept**: Create a service that monitors system color changes and refreshes the app theme in real-time.

#### Implementation Plan

1. **Create DynamicColorMonitor Service**
   - Monitor system UI mode changes
   - Detect Material You color scheme updates
   - Broadcast color change events

2. **Implement Theme Refresh Manager**
   - Listen for color change broadcasts
   - Apply fresh dynamic colors without full activity restart
   - Update theme resources dynamically

3. **Integration with Existing Theme System**
   - Extend `ThemeSwitcher` to handle dynamic refreshes
   - Update preference monitoring in `UserPreferences`

## Detailed Implementation Plan

### Phase 1: Analysis and Setup (1-2 hours)

1. **Investigate Configuration Changes**
   - Test which configuration change types are triggered by wallpaper changes
   - Verify current `onConfigurationChanged()` behavior
   - Document Android version differences

2. **Review Theme Application Process**
   - Analyze how `DynamicColors.applyToActivitiesIfAvailable()` works
   - Understand theme resource resolution process
   - Map theme change propagation through app

### Phase 2: Core Implementation (3-4 hours)

#### File: `app/src/main/AndroidManifest.xml`
```xml
<activity
    android:name=".activity.MainActivity"
    android:configChanges="keyboard|keyboardHidden|orientation|screenSize|uiMode|colorMode"
    ... />
```

#### File: `app/src/main/java/de/danoeh/antennapod/activity/MainActivity.java`

**Add to class variables:**
```java
private boolean dynamicColorsEnabled = false;
```

**Enhance `onCreate()`:**
```java
@Override
public void onCreate(Bundle savedInstanceState) {
    lastTheme = ThemeSwitcher.getNoTitleTheme(this);
    dynamicColorsEnabled = UserPreferences.getIsThemeColorTinted();
    setTheme(lastTheme);
    // ... existing code
}
```

**Enhance `onConfigurationChanged()`:**
```java
@Override
public void onConfigurationChanged(Configuration newConfig) {
    super.onConfigurationChanged(newConfig);

    // Existing drawer toggle handling
    if (drawerToggle != null) {
        drawerToggle.onConfigurationChanged(newConfig);
    }
    setNavDrawerSize();

    // Enhanced theme change detection
    @StyleRes int requiredTheme = ThemeSwitcher.getNoTitleTheme(this);
    boolean currentDynamicColorsEnabled = UserPreferences.getIsThemeColorTinted();

    if (requiredTheme != lastTheme ||
        currentDynamicColorsEnabled != dynamicColorsEnabled) {
        Log.d(TAG, "Theme or dynamic colors changed, restarting activity");
        restartActivity();
    }
}
```

**Add dynamic color refresh method:**
```java
private void refreshDynamicColors() {
    if (UserPreferences.getIsThemeColorTinted() && Build.VERSION.SDK_INT >= 31) {
        // Re-apply dynamic colors
        DynamicColors.applyToActivitiesIfAvailable((Application) getApplicationContext());

        // Check if theme changed
        @StyleRes int currentTheme = ThemeSwitcher.getNoTitleTheme(this);
        if (currentTheme != lastTheme) {
            restartActivity();
        }
    }
}
```

#### File: `app/src/main/java/de/danoeh/antennapod/PodcastApp.java`

**Add dynamic color monitoring:**
```java
@Override
public void onCreate() {
    super.onCreate();
    // ... existing initialization code

    DynamicColors.applyToActivitiesIfAvailable(this);

    // Register activity lifecycle callbacks for dynamic color monitoring
    if (Build.VERSION.SDK_INT >= 31) {
        registerActivityLifecycleCallbacks(new DynamicColorLifecycleCallbacks());
    }

    // ... rest of existing code
}

private static class DynamicColorLifecycleCallbacks implements ActivityLifecycleCallbacks {
    private int lastUiMode = -1;

    @Override
    public void onActivityResumed(Activity activity) {
        Configuration config = activity.getResources().getConfiguration();
        int currentUiMode = config.uiMode & Configuration.UI_MODE_NIGHT_MASK;

        if (lastUiMode != -1 && lastUiMode != currentUiMode) {
            if (activity instanceof MainActivity) {
                ((MainActivity) activity).refreshDynamicColors();
            }
        }
        lastUiMode = currentUiMode;
    }

    // ... implement other required methods as no-ops
}
```

### Phase 3: Testing and Validation (2-3 hours)

1. **Unit Tests**
   - Test theme change detection logic
   - Verify configuration change handling
   - Test dynamic color preference integration

2. **Integration Tests**
   - Test wallpaper change scenarios
   - Verify activity restart behavior
   - Test on multiple Android versions (12+)

3. **Manual Testing Scenarios**
   - Enable dynamic colors → change wallpaper → verify immediate update
   - Test with app in foreground during wallpaper change
   - Test with app in background during wallpaper change
   - Verify behavior when dynamic colors disabled

### Phase 4: Edge Case Handling (1-2 hours)

1. **Android Version Compatibility**
   - Ensure graceful fallback for Android < 12
   - Test Material You availability checks

2. **Performance Considerations**
   - Minimize unnecessary activity restarts
   - Optimize theme change detection frequency

3. **Error Handling**
   - Handle edge cases in dynamic color application
   - Fallback to static themes if dynamic colors fail

## Files to Modify

### Primary Changes
- `app/src/main/java/de/danoeh/antennapod/activity/MainActivity.java` - Enhanced configuration change handling
- `app/src/main/java/de/danoeh/antennapod/PodcastApp.java` - Dynamic color monitoring
- `app/src/main/AndroidManifest.xml` - Configuration change declarations

### Secondary Changes
- `ui/common/src/main/java/de/danoeh/antennapod/ui/common/ThemeSwitcher.java` - Potential optimizations
- Test files for validation

## Testing Strategy

### Automated Tests
```java
// MainActivity tests
@Test
public void testDynamicColorChangeDetection() {
    // Simulate configuration change with uiMode change
    // Verify restartActivity() is called
}

@Test
public void testThemeChangeWithDynamicColors() {
    // Enable dynamic colors
    // Change theme
    // Verify correct theme is applied
}
```

### Manual Test Cases
1. **Basic Dynamic Color Update**
   - Steps: Enable dynamic colors → Change wallpaper → Check app colors
   - Expected: App colors update immediately

2. **App State Preservation**
   - Steps: Navigate to specific screen → Change wallpaper → Check screen state
   - Expected: App returns to same screen with new colors

3. **Performance Test**
   - Steps: Rapidly change wallpaper multiple times
   - Expected: App responds smoothly without crashes

## Success Criteria

✅ **Primary Goal**: Dynamic colors update automatically when wallpaper changes
✅ **User Experience**: No manual force-stop required
✅ **Performance**: Smooth color transitions without noticeable lag
✅ **Compatibility**: Works on Android 12+ devices with Material You
✅ **Stability**: No crashes or UI glitches during color transitions

## Risk Mitigation

### Potential Issues
1. **Performance Impact**: Frequent activity restarts could affect UX
   - *Mitigation*: Optimize detection to minimize false positives

2. **Battery Usage**: Background monitoring could increase battery drain
   - *Mitigation*: Use efficient lifecycle callbacks, avoid continuous polling

3. **Compatibility**: Behavior differences across Android versions
   - *Mitigation*: Comprehensive testing on multiple versions

### Rollback Plan
- Feature flag for enhanced dynamic color handling
- Ability to disable via user preference
- Fallback to original implementation if issues detected

## Estimated Timeline

- **Analysis & Setup**: 1-2 hours
- **Core Implementation**: 3-4 hours
- **Testing & Validation**: 2-3 hours
- **Edge Cases & Polish**: 1-2 hours
- **Total**: 7-11 hours

## Next Steps

1. ✅ Create issue analysis document (this document)
2. 🔄 Implement enhanced configuration change handling
3. ⏳ Add dynamic color monitoring to PodcastApp
4. ⏳ Test implementation across Android versions
5. ⏳ Create unit and integration tests
6. ⏳ Submit pull request for review

---

*Document created: 2025-10-09*
*Issue: [#7795](https://github.com/AntennaPod/AntennaPod/issues/7795)*