# Fix Plan for Issue #6805: Auto-Skip Ending Missed When Silence Skipping is Enabled

## Issue Summary
When both "Skip Silence" and "Auto Skip End" features are enabled, auto-skip end functionality can be missed if the skip end time falls within a silent section that gets trimmed by the silence skipping feature.

**Root Cause**: The auto-skip logic relies on precise timing checks that can be bypassed when ExoPlayer's silence skipping causes position discontinuities.

## Technical Analysis

### Current Implementation
- **Auto-skip ending**: `PlaybackService.skipEndingIfNecessary()` (line 1237-1262)
  - Triggers when: `(remainingTime - skipEnd * 1000) < (getCurrentPlaybackSpeed() * 1000)`
  - Runs every second via position observer
  - Calculates `remainingTime = duration - getCurrentPosition()`

- **Silence skipping**: ExoPlayer's built-in `setSkipSilenceEnabled()` feature
  - Automatically skips silent sections during playback
  - Causes position jumps independent of the 1-second timer

### Problem Scenario
1. Episode has silent section from 27:30 to 28:00 (1650-1680 seconds)
2. Auto-skip end set to 30 seconds (trigger at 1770 seconds)
3. Silence skipping jumps position from 1650 to 1680, bypassing trigger point
4. Auto-skip end never triggers because position jumped past calculation point

## Solution Strategy

### Primary Fix: Enhanced Auto-Skip Logic
Modify `skipEndingIfNecessary()` to be more robust against position discontinuities:

1. **Track Previous Position**: Store previous position to detect large jumps
2. **Range-Based Checking**: Use position ranges instead of exact timing
3. **Adaptive Trigger Window**: Account for silence-skipping-induced position changes

### Implementation Plan

#### Phase 1: Core Logic Enhancement
**File**: `playback/service/src/main/java/de/danoeh/antennapod/playback/service/PlaybackService.java`

1. **Add Instance Variables** (around line 171):
   ```java
   private int lastCheckedPosition = -1;
   private boolean autoSkipEndTriggered = false;
   ```

2. **Enhance `skipEndingIfNecessary()` Method** (line 1237-1262):
   ```java
   private void skipEndingIfNecessary() {
       Playable playable = mediaPlayer.getPlayable();
       if (!(playable instanceof FeedMedia)) {
           return;
       }

       int duration = getDuration();
       int currentPosition = getCurrentPosition();

       // Reset trigger flag for new episodes
       if (playable != lastPlayable) {
           autoSkipEndTriggered = false;
           lastPlayable = playable;
       }

       // Skip if already triggered for this episode
       if (autoSkipEndTriggered) {
           return;
       }

       FeedMedia feedMedia = (FeedMedia) playable;
       FeedPreferences preferences = feedMedia.getItem().getFeed().getPreferences();
       int skipEnd = preferences.getFeedSkipEnding();

       if (skipEnd > 0 && skipEnd * 1000 < duration) {
           int skipTriggerPosition = duration - (skipEnd * 1000);
           int remainingTime = duration - currentPosition;

           // Detect large position jumps (likely from silence skipping)
           boolean hasPositionJump = lastCheckedPosition != -1 &&
               (currentPosition - lastCheckedPosition) > (2 * getCurrentPlaybackSpeed() * 1000);

           // Enhanced trigger logic accounting for position jumps
           boolean shouldTrigger = false;

           if (hasPositionJump && lastCheckedPosition < skipTriggerPosition && currentPosition >= skipTriggerPosition) {
               // Position jumped over trigger point due to silence skipping
               shouldTrigger = true;
               Log.d(TAG, "Auto-skip triggered after position jump: " + lastCheckedPosition + " -> " + currentPosition);
           } else if (!hasPositionJump && remainingTime <= skipEnd * 1000 &&
                      remainingTime > 0 && currentPosition >= skipTriggerPosition) {
               // Normal trigger condition
               shouldTrigger = true;
               Log.d(TAG, "Auto-skip triggered normally at position: " + currentPosition);
           }

           if (shouldTrigger) {
               autoSkipEndTriggered = true;
               Context context = getApplicationContext();
               String skipMesg = context.getString(R.string.pref_feed_skip_ending_toast, skipEnd);
               Toast.makeText(context, skipMesg, Toast.LENGTH_LONG).show();

               this.autoSkippedFeedMediaId = feedMedia.getItem().getIdentifyingValue();
               mediaPlayer.skip();
           }
       }

       lastCheckedPosition = currentPosition;
   }
   ```

3. **Reset State on Media Change** (in `onPostPlayback()` around line 1136):
   ```java
   autoSkipEndTriggered = false;
   lastCheckedPosition = -1;
   ```

#### Phase 2: Alternative Approach - Position Discontinuity Detection
**File**: `playback/service/src/main/java/de/danoeh/antennapod/playback/service/internal/ExoPlayerWrapper.java`

Add discontinuity listener to detect silence-skipping position jumps:

1. **Enhance Player Listener** (line 109):
   ```java
   @Override
   public void onPositionDiscontinuity(@NonNull Player.PositionInfo oldPosition,
                                      @NonNull Player.PositionInfo newPosition,
                                      @Player.DiscontinuityReason int reason) {
       if (audioSeekCompleteListener != null && reason == Player.DISCONTINUITY_REASON_SEEK) {
           audioSeekCompleteListener.run();
       }

       // Notify about potential silence skip discontinuity
       if (reason == Player.DISCONTINUITY_REASON_SKIP_SILENCE && positionDiscontinuityListener != null) {
           positionDiscontinuityListener.accept(new PositionJump(
               (int) oldPosition.positionMs,
               (int) newPosition.positionMs
           ));
       }
   }
   ```

2. **Add Position Jump Data Class**:
   ```java
   public static class PositionJump {
       public final int fromPosition;
       public final int toPosition;

       public PositionJump(int fromPosition, int toPosition) {
           this.fromPosition = fromPosition;
           this.toPosition = toPosition;
       }
   }
   ```

#### Phase 3: Integration and Testing

1. **Update PlaybackService** to handle position discontinuities
2. **Add Unit Tests** for the enhanced logic
3. **Integration Testing** with various podcast episodes containing silent sections

### Testing Strategy

#### Unit Tests
- Test auto-skip logic with simulated position jumps
- Verify trigger behavior with and without silence skipping
- Edge cases: multiple silent sections, very short episodes

#### Integration Tests
- Real podcast episodes with known silent sections
- Various auto-skip end times (5s, 15s, 30s, 60s)
- Different playback speeds (0.5x to 3x)

#### Manual Testing Scenarios
1. Episode with 30s silence at 29:30-30:00, auto-skip end 30s
2. Episode with multiple silent sections near the end
3. Very fast playback speeds (2x, 3x) with silence skipping
4. Short episodes (< 5 minutes) with auto-skip

### Edge Cases and Considerations

1. **Multiple Position Jumps**: Handle consecutive silence sections
2. **Playback Speed Changes**: Adjust trigger logic for variable speeds
3. **Very Short Episodes**: Ensure auto-skip doesn't trigger prematurely
4. **Background/Foreground Transitions**: Maintain state consistency
5. **Seeking During Silent Sections**: Reset trigger state appropriately

### Backward Compatibility
- Changes are purely additive to existing logic
- No breaking changes to existing APIs
- Fallback to current behavior if new logic fails

### Performance Impact
- Minimal: Only adds position tracking and simple arithmetic
- No additional network calls or heavy operations
- Existing 1-second timer frequency maintained

## Implementation Timeline

1. **Week 1**: Implement core enhanced logic (Phase 1)
2. **Week 2**: Add position discontinuity detection (Phase 2)
3. **Week 3**: Integration testing and edge case handling
4. **Week 4**: Code review, documentation, and final testing

## Success Criteria
- Auto-skip end triggers correctly when silence skipping is enabled
- No regression in existing auto-skip functionality
- No impact on normal playback performance
- Comprehensive test coverage for all scenarios

## Alternative Solutions Considered

1. **Disable Silence Skipping Near Episode End**: Simple but reduces feature utility
2. **Time-Based Rather Than Position-Based Logic**: Complex due to variable speeds
3. **ExoPlayer Event Integration**: More invasive changes to player architecture

The chosen solution balances robustness with minimal code changes and maintains full feature compatibility.